<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dopp.doppapi.mapper.auth.RefreshTokenMapper">

    <insert id="insertRefreshToken" parameterType="com.dopp.doppapi.dto.auth.RefreshTokenDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO refresh_token (
            user_id,
            token,
            user_agent,
            ip_address,
            expires_at,
            revoked,
            created_at
        ) VALUES (
            #{userId},
            #{token},
            #{userAgent},
            #{ipAddress},
            #{expiresAt},
            #{revoked},
            CURRENT_TIMESTAMP
        )
    </insert>

    <select id="findByToken" resultType="com.dopp.doppapi.dto.auth.RefreshTokenDto">
        SELECT
            id,
            user_id AS userId,
            token,
            user_agent AS userAgent,
            ip_address AS ipAddress,
            expires_at AS expiresAt,
            revoked,
            created_at AS createdAt
        FROM refresh_token
        WHERE token = #{token}
    </select>

    <update id="revokeAllUserTokens">
        UPDATE refresh_token
        SET revoked = true
        WHERE user_id = #{userId} AND revoked = false
    </update>

    <update id="revokeToken">
        UPDATE refresh_token
        SET revoked = true
        WHERE token = #{token}
    </update>

</mapper>
